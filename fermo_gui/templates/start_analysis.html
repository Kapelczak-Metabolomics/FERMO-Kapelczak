{% extends 'base.html' %}

{% block content %}
  {% from "_formhelpers.html" import render_field %}
  <div class="container mt-5">
    <h1>Start new analysis</h1>
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <h2 style="color: red">Error during input validation</h2>
        <ul class=flashes>
        {% for message in messages %}
          <li>{{ message }}</li>
        {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}
    <form method="post" action="{{ url_for('routes.start_analysis') }}" enctype="multipart/form-data">
      {{ form.hidden_tag() }}

      <div class="border p-4 my-2">
        <fieldset id="general-form">
          <div class="container-fluid">
            <div class="row my-2 d-flex align-items-center">
              <div class="col-auto"><h3>General settings</h3></div>
            </div>
          </div>
          <hr>
          <div class="general-field">
            {{ render_field(form.email) }}
            {{ render_field(form.reload_jobid) }}
          </div>
        </fieldset>
      </div>

      <div class="border p-4 my-2">
        <fieldset id="peaktable-form">
          <div class="container-fluid">
            <div class="row my-2 d-flex align-items-center">
              <div class="col-auto"><h3>Peaktable*</h3></div>
            </div>
          </div>
          <hr>
          <div class="peaktable-field d-block">
            {{ render_field(form.peaktable_file) }}
            {{ render_field(form.peaktable_format) }}
            {{ render_field(form.peaktable_polarity) }}
            {{ render_field(form.peaktable_ppm) }}
            <div class="container-fluid">
              <div class="row my-2 d-flex align-items-center">
                <div class="col-auto"><h4>Feature filter parameters</h4></div>
              </div>
            </div>
            {{ render_field(form.peaktable_filter_toggle) }}
            <div class="peaktable-filter d-none">
              <hr>
              {{ render_field(form.peaktable_filter_height_lower) }}
              {{ render_field(form.peaktable_filter_height_upper) }}
              <hr>
              {{ render_field(form.peaktable_filter_area_lower) }}
              {{ render_field(form.peaktable_filter_area_upper) }}
            </div>
          </div>
        </fieldset>
      </div>

      <div class="border p-4 my-2">
        <fieldset id="msms-form">
          <div class="container-fluid">
            <div class="row my-2 d-flex align-items-center">
              <div class="col-auto"><h3>MS/MS</h3></div>
              <div class="col-auto ms-auto"><button class="btn btn-primary btn-sm" type="button" onclick="toggleDisplay('.msms-field')">Modify parameters</button></div>
            </div>
          </div>
          <hr>
          <div class="msms-field d-none">
            {{ render_field(form.msms_file) }}
            {{ render_field(form.msms_format) }}
            {{ render_field(form.msms_rel_int_from) }}
            {{ render_field(form.msms_fragment_toggle) }}
            {{ render_field(form.msms_loss_toggle) }}
            <div class="container-fluid">
              <div class="row my-2 d-flex align-items-center">
                <div class="col-auto"><h4>Spectral networking: modified cosine</h4></div>
                <div class="col-auto ms-auto"><button class="btn btn-primary btn-sm" type="button" onclick="toggleDisplay('.msms-cosine')">Modify parameters</button></div>
              </div>
            </div>
            <hr>
            <div class="msms-cosine d-none">
              {{ render_field(form.msms_cosine_toggle) }}
              {{ render_field(form.msms_cosine_minfrag) }}
              {{ render_field(form.msms_cosine_tolerance) }}
              {{ render_field(form.msms_cosine_score) }}
              {{ render_field(form.msms_cosine_links) }}
            </div>
            <div class="container-fluid">
              <div class="row my-2 d-flex align-items-center">
                <div class="col-auto"><h4>Spectral networking: MS2DeepScore</h4></div>
                <div class="col-auto ms-auto"><button class="btn btn-primary btn-sm" type="button" onclick="toggleDisplay('.msms-deepscore')">Modify parameters</button></div>
              </div>
            </div>
            <hr>
            <div class="msms-deepscore d-none">
              {{ render_field(form.msms_deepscore_toggle) }}
              {{ render_field(form.msms_deepscore_minfrag) }}
              {{ render_field(form.msms_deepscore_score) }}
              {{ render_field(form.msms_deepscore_links) }}
            </div>
          </div>
        </fieldset>
      </div>

      <div class="border p-4 my-2">
        <fieldset id="group-form">
          <div class="container-fluid">
            <div class="row my-2 d-flex align-items-center">
              <div class="col-auto"><h3>Group Metadata</h3></div>
              <div class="col-auto ms-auto"><button class="btn btn-primary btn-sm" type="button" onclick="toggleDisplay('.group-field')">Modify parameters</button></div>
            </div>
          </div>
          <hr>
          <div class="group-field d-none">
            {{ render_field(form.group_file) }}
            {{ render_field(form.group_format) }}
            <h4 class="col-md-auto">Blank Assignment</h4>
            <hr>
            {{ render_field(form.group_blank_toggle) }}
            <div class="group-blank d-none">
              {{ render_field(form.group_blank_factor) }}
              {{ render_field(form.group_blank_algorithm) }}
              {{ render_field(form.group_blank_value) }}
              <hr>
            </div>
            <h4 class="col-md-auto">Group Factor Assignment</h4>
            <hr>
            {{ render_field(form.group_factor_toggle) }}
            <div class="group-factor d-none">
              {{ render_field(form.group_factor_algorithm) }}
              {{ render_field(form.group_factor_value) }}
            </div>
          </div>
        </fieldset>
      </div>

      <div class="border p-4 my-2">
        <fieldset id="phenotype-form">
          <div class="container-fluid">
            <div class="row my-2 d-flex align-items-center">
              <div class="col-auto"><h3>Phenotype Data</h3></div>
              <div class="col-auto ms-auto"><button class="btn btn-primary btn-sm" type="button" onclick="toggleDisplay('.phenotype-field')">Modify parameters</button></div>
            </div>
          </div>
          <hr>
          <div class="phenotype-field d-none">
            {{ render_field(form.phenotype_file) }}
            {{ render_field(form.phenotype_format) }}
            <hr>
            <div class="phenotype-qualitative d-none">
              {{ render_field(form.phenotype_qualit_factor) }}
              {{ render_field(form.phenotype_qualit_algorithm) }}
              {{ render_field(form.phenotype_qualit_value) }}
            </div>
            <div class="phenotype-quantitative d-none">
              {{ render_field(form.phenotype_quant_average) }}
              {{ render_field(form.phenotype_quant_value) }}
              {{ render_field(form.phenotype_quant_algorithm) }}
              {{ render_field(form.phenotype_quant_p_val) }}
              {{ render_field(form.phenotype_quant_coeff) }}
            </div>
          </div>
        </fieldset>
      </div>

      <div class="border p-4 my-2">
        <fieldset id="library-form">
          <div class="container-fluid">
            <div class="row my-2 d-flex align-items-center">
              <div class="col-auto"><h3>Spectral Library</h3></div>
              <div class="col-auto ms-auto"><button class="btn btn-primary btn-sm" type="button" onclick="toggleDisplay('.library-field')">Modify parameters</button></div>
            </div>
          </div>
          <hr>
          <div class="library-field d-none">
            {{ render_field(form.library_file) }}
            {{ render_field(form.library_format) }}
            <h4 class="col-md-auto">Matching: modified cosine</h4>
            <hr>
            {{ render_field(form.library_cosine_toggle) }}
            <div class="library-cosine d-none">
              {{ render_field(form.library_cosine_tolerance) }}
              {{ render_field(form.library_cosine_matches) }}
              {{ render_field(form.library_cosine_score) }}
              {{ render_field(form.library_cosine_mzdiff) }}
            </div>
            <h4 class="col-md-auto">Matching: MS2DeepScore</h4>
            <hr>
            {{ render_field(form.library_deepscore_toggle) }}
            <div class="library-deepscore d-none">
              {{ render_field(form.library_deepscore_score) }}
              {{ render_field(form.library_deepscore_mzdiff) }}
            </div>
          </div>
        </fieldset>
      </div>

      <div class="border p-4 my-2">
        <fieldset id="ms2query-form">
          <div class="container-fluid">
            <div class="row my-2 d-flex align-items-center">
              <div class="col-auto"><h3>MS2Query Annotation</h3></div>
              <div class="col-auto ms-auto"><button class="btn btn-primary btn-sm" type="button" onclick="toggleDisplay('.ms2query-field')">Modify parameters</button></div>
            </div>
          </div>
          <hr>
          <div class="ms2query-field d-none">
            {{ render_field(form.ms2query_file) }}
            {{ render_field(form.ms2query_toggle) }}
            <hr>
            {{ render_field(form.ms2query_score) }}
          </div>
        </fieldset>
      </div>

      <div class="border p-4 my-2">
        <fieldset id="askcb-form">
          <div class="container-fluid">
            <div class="row my-2 d-flex align-items-center">
              <div class="col-auto"><h3>antiSMASH Job Integration</h3></div>
              <div class="col-auto ms-auto"><button class="btn btn-primary btn-sm" type="button" onclick="toggleDisplay('.askcb-field')">Modify parameters</button></div>
            </div>
          </div>
          <hr>
          <div class="askcb-field d-none">
            {{ render_field(form.askcb_jobid) }}
            {{ render_field(form.askcb_score) }}
            <h4 class="col-md-auto">Matching: modified cosine</h4>
            <hr>
            {{ render_field(form.askcb_cosine_toggle) }}
            <div class="askcb-cosine d-none">
              {{ render_field(form.askcb_cosine_tolerance) }}
              {{ render_field(form.askcb_cosine_matches) }}
              {{ render_field(form.askcb_cosine_score) }}
              {{ render_field(form.askcb_cosine_mzdiff) }}
            </div>
            <h4 class="col-md-auto">Matching: MS2DeepScore</h4>
            <hr>
            {{ render_field(form.askcb_deepscore_toggle) }}
            <div class="askcb-deepscore d-none">
              {{ render_field(form.askcb_deepscore_score) }}
              {{ render_field(form.askcb_deepscore_mzdiff) }}
            </div>
          </div>
        </fieldset>
      </div>
      <fieldset class="p-4 my-2">
        <div class="container-fluid">
          <div class="row">
            <div class="col-auto mx-auto">
              <button type="submit" class="btn btn-primary">Start Analysis</button>
            </div>
          </div>
        </div>
      </fieldset>
    </form>
  </div>
  <script type="text/javascript" src="{{ url_for('static', filename='js/forms.js') }}"></script>
{% endblock %}