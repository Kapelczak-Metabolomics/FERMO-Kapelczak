{% extends 'base.html' %}

{% block content %}
    <span class="title"><h1>{% block title %} Job submitted {% endblock %}</h1></span>
    <div class="content">
        <h5>Job ID: {{ job_data.get("task_id") }}</h5>
        <h5>Once the job is completed, this site will automatically redirect to the results.</h5>
        <h5>The results will be made available under: <a href="{{ job_data.get('root_url') }}/results/{{ job_data.get('task_id') }}/">{{ job_data.get('root_url') }}/results/{{ job_data.get('task_id') }}/</a></h5>
        <h5>If you have specified an email, you will be notified (provided that FERMO is running as an online application).</h5>
    </div>
    <script type="text/javascript" charset="utf-8">
        // Uses socket.io to poll for job status via getStatus()
        var socket = io();

        // Test function to verify connection to SocketIO (for debugging purposes)
        socket.on('connect', function() {
            socket.emit('startup_event', {data: 'Connected to SocketIO.'});
        });

        // Responds to poll return message with wait or redirects, depending on outcome
        socket.on('job_status', function(data) {
            if (data.status === 'job_successful') {
                window.location.href = "{{ job_data.get('root_url') }}/results/{{ job_data.get('task_id') }}/";
            } else if (data.status === 'job_running') {
                // pass and wait for next cycle
            } else if (data.status === 'job_not_found') {
                window.location.href = "{{ job_data.get('root_url') }}/results/job_not_found/{{ job_data.get('task_id') }}/";
            } else {
                window.location.href = "{{ job_data.get('root_url') }}/results/job_failed/{{ job_data.get('task_id') }}/";
            }
        });

        // Polling function; triggered every n seconds. Requests status update.
        function getStatus() {
            socket.emit('get_status', {task_id: {{ job_data.get("task_id")|tojson|safe }}});
        }
        setInterval(getStatus, 5000);
        getStatus();
    </script>
{% endblock %}